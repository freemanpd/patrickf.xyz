---
apiVersion: v1
kind: ConfigMap
metadata:
  name: patrickf-djagno-backend-config
data:
  DB_HOST: {{ .Values.DBHOST }} #e.g. postgres
  DB_NAME: {{ .Values.DBNAME }}
  DB_USER: {{ .Values.DBUSER }}
  DB_PASS: {{ .Values.DBPASS }}
  DB_PORT: {{ .Values.DBPORT }}
  DB_SECRETKEY: {{ .Values.DBSECRETKEY }}
  DB_DEBUGLOG: {{ .Values.DBDEBUGLOG }}

apiVersion: batch/v1
kind: Job
metadata:
  name: patrickfxyz/patrickfxyz-django-backend-migrate
  labels:
    name: django-k8s-starter
    type: migrate
spec:
  template:
    spec:
      containers:
      - name: patrickfxyz/patrickfxyz-django-backend-migrate
        image: patrickfregistry.azurecr.io/patrickfxyz/patrickfxyz-django-backend:0.0.1
        command: ["python",  "manage.py", "migrate", "--noinput"]
        envFrom:
        - configMapRef:
            name: patrickfxyz-django-backend-config
      restartPolicy: Never
  backoffLimit: 4